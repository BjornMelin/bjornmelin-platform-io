name: CI

on:
  push:
    branches: [develop]  # main is handled by deploy.yml
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  ci:
    name: CI Pipeline
    uses: ./.github/workflows/_reusable-ci.yml
    with:
      run-e2e: true
      run-unit-tests: true

  actionlint:
    name: Actionlint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          reporter: github-check
          level: error

  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [ci, actionlint]
    if: always()
    steps:
      - name: Check all job statuses
        run: |
          good() { case "$1" in success|skipped) return 0;; *) return 1;; esac; }
          if ! good "${{ needs.ci.result }}"; then echo "CI failed"; exit 1; fi
          if ! good "${{ needs.actionlint.result }}"; then echo "Actionlint failed"; exit 1; fi
          echo "All CI checks passed successfully!"
