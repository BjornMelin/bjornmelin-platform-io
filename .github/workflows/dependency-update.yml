name: Dependency Update Check

on:
  schedule:
    - cron: '0 9 1 * *' # Monthly on the 1st at 09:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: Check and Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js and Bun
        uses: ./.github/actions/setup-bun
        with:
          install: "true"


      - name: Check for updates
        id: check-updates
        run: |
          echo "Checking for outdated dependencies..."
          OUTDATED=$(bun outdated --no-summary || true)
          {
            echo 'outdated<<__OUTDATED_JSON__'
            echo "$OUTDATED"
            echo '__OUTDATED_JSON__'
          } >> "$GITHUB_OUTPUT"

          UPDATES=$(echo "$OUTDATED" | awk -F'|' 'NF>4 && $2 !~ /Package/ && $2 !~ /^-+$/ && $2 ~ /[A-Za-z0-9@]/ {print $0}')
          if [ -n "$UPDATES" ]; then
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
            echo "Found outdated dependencies"
          else
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            echo "All dependencies are up to date"
          fi

      - name: Update dependencies
        if: steps.check-updates.outputs.has_updates == 'true'
        env:
          # Provide safe defaults so `bun run build` doesn't fail on required env vars.
          # This workflow is only a dependency sanity check, not a production deploy.
          NEXT_PUBLIC_APP_URL: https://bjornmelin.io
          CONTACT_EMAIL: test@example.com
          SKIP_ENV_VALIDATION: "true"
        run: |
          # Update non-major versions
          bun update
          
          # Run tests to ensure nothing is broken
          bun run test
          bun run build

      - name: Create Pull Request
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update dependencies'
          title: 'chore(deps): automated dependency updates'
          body: |
            ## ðŸ”„ Automated Dependency Updates
            
            This PR contains automated dependency updates for non-major versions.
            
            ### âœ… Checks Performed
            - All tests pass
            - Build succeeds
            - No security vulnerabilities found
            
            ### ðŸ“‹ Updated Dependencies
            Please review the changes in `package.json`, `bun.lock`, and `infrastructure/bun.lock`.
            
            ---
            _This PR was automatically created by the dependency update workflow._
          branch: deps/automated-updates
          delete-branch: true
          labels: |
            dependencies
            automated
          assignees: BjornMelin
          reviewers: BjornMelin
