name: Deploy Portfolio

on:
  push:
    branches:
      - main
    paths-ignore:
      - "infrastructure/**"
      - "**.md"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Validate build + AWS auth/outputs only (no S3 upload / no CloudFront invalidation)"
        required: false
        type: boolean
        default: false
      skip_smoke_check:
        description: "Skip post-deploy smoke check (workflow_dispatch only)"
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1

jobs:
  preflight:
    name: Preflight (Production Config)
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - name: Validate required secrets/variables
        shell: bash
        env:
          AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
        run: |
          set -euo pipefail

          if [[ -z "${AWS_DEPLOY_ROLE_ARN}" ]]; then
            echo "Missing required secret: AWS_DEPLOY_ROLE_ARN" >&2
            exit 1
          fi
          if [[ ! "${AWS_DEPLOY_ROLE_ARN}" =~ ^arn:aws:iam::[0-9]{12}:role/.+ ]]; then
            echo "AWS_DEPLOY_ROLE_ARN must be a full IAM Role ARN (got a non-ARN value)." >&2
            echo "Expected format: arn:aws:iam::123456789012:role/prod-portfolio-deploy" >&2
            exit 1
          fi

          if [[ -z "${CONTACT_EMAIL}" ]]; then
            echo "Missing required variable: CONTACT_EMAIL (GitHub Environment: production)" >&2
            exit 1
          fi
          if [[ ! "${CONTACT_EMAIL}" =~ ^[^@[:space:]]+@[^@[:space:]]+\.[^@[:space:]]+$ ]]; then
            echo "CONTACT_EMAIL must be a valid email address (GitHub Environment: production)." >&2
            exit 1
          fi

          if [[ -z "${NEXT_PUBLIC_APP_URL}" ]]; then
            echo "Missing required variable: NEXT_PUBLIC_APP_URL (GitHub Environment: production)" >&2
            exit 1
          fi
          if [[ ! "${NEXT_PUBLIC_APP_URL}" =~ ^https?:// ]]; then
            echo "NEXT_PUBLIC_APP_URL must start with http:// or https:// (GitHub Environment: production)." >&2
            exit 1
          fi

  ci:
    name: CI Pipeline
    uses: ./.github/workflows/_reusable-ci.yml
    needs: preflight
    with:
      run-e2e: true
      run-unit-tests: true

  deploy:
    name: Deploy to Production
    needs: ci
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: 'true'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: github-actions-deploy
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Build Next.js App (Static Export)
        env:
          NEXT_PUBLIC_BASE_URL: ${{ vars.NEXT_PUBLIC_BASE_URL }}
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: pnpm build

      - name: Get Stack Outputs
        id: stack-outputs
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          # shellcheck disable=SC2016 # Backticks are JMESPath syntax, not command substitution
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name prod-portfolio-storage \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteBucketName`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          # shellcheck disable=SC2016
          DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name prod-portfolio-storage \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          echo "bucket=$BUCKET_NAME" >> "$GITHUB_OUTPUT"
          echo "distribution=$DIST_ID" >> "$GITHUB_OUTPUT"

      - name: Check if Stack Outputs were retrieved
        if: steps.stack-outputs.outcome != 'success'
        run: |
          echo "Failed to retrieve stack outputs. Check your user permissions and make sure 'prod-portfolio-storage' stack exists."
          exit 1

      - name: Upload to S3
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.dry_run != true }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Uploading static files to s3://${{ steps.stack-outputs.outputs.bucket }}"
          aws s3 sync out/ s3://${{ steps.stack-outputs.outputs.bucket }} --delete

      - name: Upload to S3 (dry-run)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == true }}
        shell: bash
        run: |
          set -euo pipefail
          echo "DRY RUN: validating S3 sync permissions for s3://${{ steps.stack-outputs.outputs.bucket }}"
          aws s3 sync out/ s3://${{ steps.stack-outputs.outputs.bucket }} --delete --dryrun

      - name: Invalidate CloudFront
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.dry_run != true }}
        shell: bash
        run: |
          set -euo pipefail
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.stack-outputs.outputs.distribution }} \
            --paths "/*"

  smoke-check:
    name: Post-Deploy Smoke Check
    runs-on: ubuntu-latest
    needs: deploy
    if: |
      needs.deploy.result == 'success' &&
      !(
        github.event_name == 'workflow_dispatch' &&
        (inputs.dry_run == true || inputs.skip_smoke_check == true)
      )

    steps:
      - name: Run smoke check
        id: smoke
        env:
          SMOKE_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
        run: |
          set +e
          url="${SMOKE_URL:-https://bjornmelin.io}"
          http_code=$(curl --retry 3 --retry-delay 5 --max-time 15 -s -o /tmp/response "$url" -w "%{http_code}")
          exit_code=$?

          echo "http_code=$http_code" >> "$GITHUB_OUTPUT"
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

          if [ "$exit_code" -eq 0 ] && [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "Smoke check failed for $url (exit: $exit_code, status: $http_code)."
            if [ "${SMOKE_DEBUG:-false}" = "true" ]; then
              echo "----- Response Body (truncated) -----"
              head -c 2048 /tmp/response || true
            fi
          fi

      - name: Deployment summary
        if: always()
        env:
          APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
          SMOKE_STATUS: ${{ steps.smoke.outputs.status }}
          SMOKE_HTTP_CODE: ${{ steps.smoke.outputs.http_code }}
        run: |
          status="${SMOKE_STATUS:-unknown}"
          http_code="${SMOKE_HTTP_CODE:-n/a}"
          app_url="${APP_URL:-https://bjornmelin.io}"
          {
            echo "## Deployment Summary"
            echo ""
            echo "- Commit: \`$GITHUB_SHA\`"
            echo "- Workflow Run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
            echo "- App URL: ${app_url}"
            echo "- Smoke Check Status: ${status:-unknown}"
            echo "- HTTP Status Code: ${http_code}"
            echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail when smoke check failed
        if: ${{ steps.smoke.outputs.status == 'failure' }}
        run: |
          echo "Smoke check did not succeed. Failing workflow."
          exit 1
