name: Reusable CI

on:
  workflow_call:
    inputs:
      run-e2e:
        type: boolean
        default: true
        description: Run E2E tests
      run-unit-tests:
        type: boolean
        default: true
        description: Run unit tests
    outputs:
      build-success:
        description: Whether the build succeeded
        value: ${{ jobs.build.outputs.success }}

env:
  SKIP_ENV_VALIDATION: 'true'
  NEXT_PUBLIC_APP_URL: 'https://bjornmelin.io'

jobs:
  lint-and-type-check:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and Bun
        uses: ./.github/actions/setup-bun
        with:
          install: 'true'

      - name: Run Biome linting
        run: bun run lint

      - name: Run type checking
        run: bun run type-check

  unit-tests:
    name: Unit Tests
    if: ${{ inputs.run-unit-tests }}
    needs: lint-and-type-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and Bun
        uses: ./.github/actions/setup-bun
        with:
          install: 'true'

      - name: Run unit tests with coverage
        run: bun run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: unit-coverage
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report-${{ github.run_id }}
          path: coverage/
          retention-days: 7

  e2e-tests:
    name: E2E Tests
    if: ${{ inputs.run-e2e && needs.e2e-build.outputs.present == 'true' }}
    needs:
      - lint-and-type-check
      - e2e-shards
      - e2e-build
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.e2e-shards.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and Bun
        uses: ./.github/actions/setup-bun
        with:
          install: 'true'

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: bun --bun playwright install --with-deps chromium

      - name: Detect E2E tests presence
        id: detect
        run: |
          set -euo pipefail
          if [ -n "${{ hashFiles('e2e/**','tests/e2e/**','playwright/tests/**') }}" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download static export
        if: steps.detect.outputs.present == 'true'
        uses: actions/download-artifact@v6
        with:
          name: e2e-static-out
          path: .

      - name: Run E2E tests
        if: steps.detect.outputs.present == 'true'
        run: bun run test:e2e -- --shard=${{ matrix.shard }}/${{ needs.e2e-shards.outputs.total }}
        env:
          NODE_ENV: test

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always() && steps.detect.outputs.present == 'true'
        with:
          name: playwright-report-${{ github.run_id }}-shard-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 7

  e2e-shards:
    name: E2E Shard Plan
    if: ${{ inputs.run-e2e }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
      total: ${{ steps.plan.outputs.total }}
    steps:
      - name: Compute shard matrix
        id: plan
        run: |
          set -euo pipefail
          cores="$(nproc)"
          max_shards=4
          total="$cores"
          if [ "$total" -gt "$max_shards" ]; then
            total="$max_shards"
          fi
          if [ "$total" -lt 1 ]; then
            total=1
          fi
          shards="$(seq 1 "$total" | paste -sd "," -)"
          echo "total=$total" >> "$GITHUB_OUTPUT"
          echo "matrix={\"shard\":[${shards}]}" >> "$GITHUB_OUTPUT"

  e2e-build:
    name: E2E Build Artifact
    if: ${{ inputs.run-e2e }}
    needs: lint-and-type-check
    runs-on: ubuntu-latest
    outputs:
      present: ${{ steps.detect.outputs.present }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and Bun
        uses: ./.github/actions/setup-bun
        with:
          install: 'true'

      - name: Detect E2E tests presence
        id: detect
        run: |
          set -euo pipefail
          if [ -n "${{ hashFiles('e2e/**','tests/e2e/**','playwright/tests/**') }}" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build application
        if: steps.detect.outputs.present == 'true'
        run: bun run build
        env:
          NEXT_PUBLIC_ALLOW_LOCAL_CONTACT: "true"
          NEXT_PUBLIC_APP_URL: "http://localhost:3100"
          NEXT_PUBLIC_BASE_URL: "http://localhost:3100"
          NEXT_PUBLIC_API_URL: "http://localhost:3100/api"
          SKIP_IMAGE_VARIANTS: "true"

      - name: Upload static export
        if: steps.detect.outputs.present == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: e2e-static-out
          path: out/
          retention-days: 3

  build:
    name: Build Check
    needs: [lint-and-type-check, unit-tests, e2e-tests]
    if: |
      always() &&
      needs.lint-and-type-check.result == 'success' &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped') &&
      (needs.e2e-tests.result == 'success' || needs.e2e-tests.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.build.outcome == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and Bun
        uses: ./.github/actions/setup-bun
        with:
          install: 'true'

      - name: Build production bundle
        id: build
        run: bun run build

      - name: Check bundle size
        run: |
          echo "Build Output:"
          du -sh out/
          find out -type f -name "*.js" -o -name "*.css" | head -20
