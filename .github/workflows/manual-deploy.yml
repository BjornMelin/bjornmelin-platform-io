name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean
      reason:
        description: 'Reason for manual deployment'
        required: true
        type: string

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write
  id-token: write

env:
  AWS_REGION: us-east-1

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Log deployment reason
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          DEPLOY_REASON: ${{ inputs.reason }}
          DEPLOY_SKIP_TESTS: ${{ inputs.skip_tests }}
        run: |
          echo "üöÄ Manual deployment initiated"
          echo "Environment: $DEPLOY_ENV"
          echo "Initiated by: ${{ github.actor }}"
          echo "Reason: $DEPLOY_REASON"
          echo "Skip tests: $DEPLOY_SKIP_TESTS"

      - name: Validate environment
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          GIT_REF: ${{ github.ref }}
        run: |
          if [[ "$DEPLOY_ENV" == "production" && "$GIT_REF" != "refs/heads/main" ]]; then
            echo "‚ùå Production deployments are only allowed from the main branch"
            exit 1
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.skip_tests != true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: "true"

      - name: Run tests
        run: |
          pnpm lint
          pnpm type-check
          pnpm test

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: always() && needs.validate.result == 'success' && (needs.test.result == 'success' || inputs.skip_tests == true)
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deployment-url.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: "true"

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENVIRONMENT: ${{ inputs.environment }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: github-actions-manual-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to environment
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
        run: |
          echo "Deploying to $DEPLOY_ENV..."
          # Add actual deployment commands here
          # Example: aws s3 sync out/ s3://${{ vars.S3_BUCKET }}-$DEPLOY_ENV/
          # Example: aws cloudfront create-invalidation --distribution-id ${{ vars.CF_DISTRIBUTION_ID }}

      - name: Set deployment URL
        id: deployment-url
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
        run: |
          if [[ "$DEPLOY_ENV" == "production" ]]; then
            echo "url=https://bjornmelin.io" >> "$GITHUB_OUTPUT"
          else
            echo "url=https://$DEPLOY_ENV.bjornmelin.io" >> "$GITHUB_OUTPUT"
          fi

      - name: Create deployment record
        uses: actions/github-script@v8
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          DEPLOY_REASON: ${{ inputs.reason }}
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: process.env.DEPLOY_ENV,
              description: `Manual deployment: ${process.env.DEPLOY_REASON}`,
              auto_merge: false,
              required_contexts: []
            });

      - name: Send deployment notification
        if: always()
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [[ "$JOB_STATUS" == "success" ]]; then
            echo "‚úÖ Deployment to $DEPLOY_ENV completed successfully"
          else
            echo "‚ùå Deployment to $DEPLOY_ENV failed"
          fi
