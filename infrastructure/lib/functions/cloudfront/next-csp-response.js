/* biome-ignore-all lint/style/useTemplate: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/complexity/useOptionalChain: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noUnusedVariables: CloudFront handler is invoked by AWS. */
/* biome-ignore-all lint/style/useConst: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/suspicious/noGlobalIsNan: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noInnerDeclarations: CloudFront Functions require ES5.1. */
/**
 * Generated file -- do not edit by hand.
 *
 * Generated by: `pnpm generate:csp-hashes`
 *
 * CloudFront Functions runtime constraints:
 * - JavaScript runtime 2.0
 * - Uses CloudFront KeyValueStore for per-path hash indices (keeps code size < 10 KB)
 */
import cf from 'cloudfront';
var kvsHandle = cf.kvs();

var HASH_B64 = ["+AFufN2h11USbn7wyOpZYk546mixy0iQlfvMtpR3d18=","/+GwKS8RMmXJVFHx50WyGF6HDz90wmJRJ5EMh3lkWmc=","/k734VXHJveAlproTq2PKhTMsnd2wj6/teOtBJsQVRY=","13silCBhf0eoqC1s/VWjP+QwOu2KrIiFunzRMmxOTto=","2BnK0ZkZETJmDCMAtabBECOtwcuKLGA+nACBuGoAMKU=","2EyubIO0K/ZfYHrR2OUlwIGflhoEyk+fUv8lwtviubY=","2TsLCBKr7P9+tWvkNXXJbHL4KnlhRuifr321QB0vRUI=","4IxuVc4NdUNvOLOoYjStJZw8OKVrwLKcDcNdWkcED9A=","4ltQYJvFOh+mmEP7Jq9KlrWS0dcYblSIikk4fWVpRuo=","53a5YsXL59Im/IN8OGQ1wNNav1Q1AajUaN1RcoPZN6M=","6DksqGuANKbi2N7NfcHEwjrJVX1IVvpbd8egxmNxDfA=","6fLsWmkeHd1MzN9723tnyzrVoQ3cgnq/g0YvwdjlCoM=","6hr/49XqMkPlyUtRVPPGh6sAfLOVVrmnk7oc/GOtG2E=","7mu4H06fwDCjmnxxr/xNHyuQC6pLTHr4M2E4jXw5WZs=","8BXtKYQUOyeH/C/8qoGD28yfKrpweJ6PHXajpKoLvFM=","8pUQPrt5srK/VP0PR90owSimDmZkxyDyYg5LV8PGzkc=","98l5qck8jbs8vp8VotueOJL3CeNpYpTzfW8JOY1Bde4=","9F/EJQMyHzcTFLcg7QmCIhPzUe8nwNGZPOV/wCAXFNs=","9cspBNvxW6BrzApZKt1QK7+e1JBxzkO262o+4lU18Lg=","9lyiYKQjf4dM0Xxw+wN6F2htcGM4HTqCe5bHnCweKMQ=","B3RJp59BQF0+luF5Ch3G6yH6TE9rFS6HxfFDWN3zQg0=","CCoEm9AXhRNzlRIPt9w5XVk01eaCnnB8/IP0hfIxqQg=","CRusmLMEW/8FfnIqn/q0/LOurqtfVfTu0KDY7eU7WDQ=","Cq8btV/vi++vKKRdDI+B7Dfu9Ij3qvxQzDG5pVSA0pw=","EueyFygYdXyM0Yt5YAGzFZ9S7QmejEAMsqFnkMrv6O4=","Ez0JMWsoDEdjI0tWipCKApy3yBJ7W9f7TQ6pO5w4ORo=","FxI+W5dgL3VVPTmjAV1jT4SChe39z1wxV9bLQDP2Rro=","GZllLf62thRtVagbH1DvWaBT/Pta95E+q1lPAu6Lqcw=","HI9nTstKlmC8sqWDuMUoxfq+eMnjKJe6NyilX9NC2yk=","IHPd0nT4JlzDZpB9+jFLME/z0KSCKecNo5+QbdqTEqQ=","L8AvlrB97T62Xg/jD/Dniz1Wv0x5wkK0RaWDw8XBH5g=","LC6yMjC61xsl8PlUeuC9i49fQWPv52dNomsV/YtmeRo=","LxP8a1IVyK2zY42Z+l8EC+T+YQ7lSoKemcfI9wkheRg=","NNox2+YnzhUYE0YV5azUu5EFLsSLmt+owyVUgtFZ2QM=","NRKHgPKD/22ofWB6C8JiNiMqcPjT9OkuKSmUDNATJuU=","NmpxgUipG0+aFTo+NJMiIyKyOVNKBiOd+P+m6PcIvfI=","OBTN3RiyCV4Bq7dFqZ5a2pAXjnCcCYeTJMO2I/LYKeo=","OH58X5c9Jdm0NfoRPUW/RmaADh9T5z93x+1S1s7mNBg=","P3ezet0MbdUnHPt+0Syk5SRsEcHFi2hiahkKnhw8h3Y=","P9Pqmfti8tG5A4M0/L0VgxvWweWTLvj+Dws/8SR25lY=","PoUmiMVMVwMf3kHf+nIsGO3wck5fg8DrruuOLs+3+Sw=","QAlSewaQLi/NPCznjAZSyvQ72heD0VdxmNDDkZeCxgc=","QZikDM9/FY+OR1wT+qXLuKn1MOBGY81QTekhTinA9eA=","Qx0tge8aq1xTHktGZtsxZ/xUYsObnM8ZRod+mLciYVg=","RSrGdmgPN+QZTfZWwgLVBWVwNtZ5w3UpjpQTWn0v9Zg=","RXLuW5bffvW4+5f59R7kVluOceZf1q6u2BxZxS+Yc+Q=","T5uUSbFBxlER4n6MW6mxwxmKKZCvUh3XUD3JLD8rrfY=","UeJKOQpyD7arTq43qZQFnr83eixTqp90tRHRf8ss2U0=","UsmLCVNUPESPQfRrU2KNyeKUcL3RVZg8At+xk6XL0zM=","W8ele/1TR8WBPsx75+b5OLzYZNqW3FXBTPA+1ccl7cw=","WX5vyNDoUgIECJDsFg3D8NA2WEUgLiyDRkK+tRg8hJ4=","WtXifAl1KtLmbbdXZFvTLiC8iAW4nPNL8Xd+JpGnd1w=","XIa6b5cmu1wjNXeyiPt+bsJx2saRjeddEJ87PyBxV88=","XVZcecpM/mdrbQGMAJ6LWWPgl+y/odN/buLKKhrtOK8=","Yf/iJv/5gSiO5oNsUvq246AHV4FU4naO0nwY6GuKlMA=","ZZaarBhKP6xN7C62dh3yuNi8ZdUnHz8yVy04K7JNvJI=","Zz2arZBtYvZFF1oPVSAhvl0pKgn9faV7o1DzSnYddV8=","a5TL66lQuu/HSIqk2lBQ9yZWeYT3hd68b6i7+zSZ51U=","aA3PcqDjFhURVP7ISXEsMir6BfnLjUKmEyyIbJgGPbs=","aAdwZMRRYwjJdNowuZGgHAJs8YuLrqlmAqBQoPg5j+4=","aCZI7pePVyQsGx3LCNW1o9hbklrPZTWGnIZ8nrGj2ss=","aL29xglzCSBxWwwQNS+wCIrBCVeTfqyjr+QVLpk1LOU=","bdm7wDZHh2N+/uAVYB4jW1hsqMK0l7S3rRSYfYI2kt8=","cMJOvl7JDvaR82rGHTs8Fs6GIROWM6x+29b/8dIdGE0=","cmfAZZoeWQfQy54eN7TSPkbGXNWyn4fEer/0BNz4R/M=","eoVSr1RSYYcnZ0h6bcmq9ebcObjQ5gbo8XIrKACucJ4=","eqgwKOytgYauDBcu2LeDdcdRWJ530NAH8NU+kFQ9HwQ=","fx/uyO1DqKeFpNXTDkSezBWW4RNkaIbMOPv0p5WamDg=","g143Z/P7VgoFwdewDwWkdzJAHIU2gvYK/hXzZoD7PXQ=","gOHjRfz+dg8r73i9W+UDQ4vPJTp3RXPvrHVg9tz8yyE=","gnDPPi+Rc+5TS68YgHAgsTjCBmJh1KUwoXxGZKyi+BQ=","hC/DjRbo2qkpIiSTJeo9vmMDdG3UtnkfwDLjIiAy2Fo=","hH8VBEwATdyzXH7FZBDq8MCb9Skcj8oQuJUgSJ8+o/M=","hmKsr33yzkUdHT7MI6PYo+RwAgHuAcx5CbjFrD8C7Uk=","hopkCvVKqE9WcAMT75VAt4i4XxdG4Gt37cPbHs8cqB8=","i4WmghuwiOyhwmnqg1d+V57C7EiPl5aE5/6pMlclmwU=","iJVwjUWYhzeq6LbzCUBckBH6+Ey00rFYZbThdgW47uw=","iUyuxuHaEZok09DTpHlZ/eMm4mY8XNSzeqiW7UsCLao=","k2QZFq8tkAMoEUdmG9MgYOfx9sFFHvIIqvroIArbmSI=","k8nFaLU386vO8hvPpxkYiPtCFzcbzSTp3Hu/ErdKIr8=","l19YvCqOU3GqFhu3PPrpSyksX2+X/6TEh2K8bQbTewY=","l6cUixYEy82+dj/XSWfijxra7YWZc/k7tBLiWJkqkdQ=","mpi+mIoqZ9EM0e0NSC1mt/hndJozD58TJ7Z1w3cTD6E=","nRlraIPbXd9dc5yvi7VbPLP17r3bnKFbKTP+aWLUELs=","nY0qx00a91mJhN2e4Ly1j9aZ+cB1jB0Pk3e2n6wpcyU=","o0uEB98CI4J1TydI5Y1sagbLGZrp7VkeX6EWMITwT+Q=","oA1qo58cZ4kHiMQDODzbgPXvZhInisrdSYP+8U1PJvA=","oDIT680f+PBZbAlx09mlwAh07Dj89KKxjBYLc+QcN4Y=","oupdWBANd4guLriRF37RkTIIllNndBS01lys+O4mD9g=","ox1vo8sWdwE2+YS6jiML+0XsY3sNMLts6Arsgbbx/8U=","pJ2bndtQIMYRU07ExIoqL6tYmKf4FKPegNQNKWR8gRY=","pl6iXW3h5YQxetLyz4f+J9bhSHH4ui3xJ1l+ukuzn+Q=","ppncqXtC52/RLC8LWRJ363lOaTVGuuF9ZR8eizWxEZY=","rnbCIuDHUtgzBIU37aUShucg5gJp7q1iXP5dxs5AO78=","rtHAScahEScD7capKk1SeB5kVPg11sU5p8jg4IlycKo=","t0VVnHGFyn0fpIEiPGwtM5cFH11EZ/wXsKQE3ckYVl8=","u2YqR2PhoH6VwKt66kpSQOpvLApYgU9GwAgp82uYXJ8=","uem4EkJujTHeW/D2E/QvmZy78HxvxPBN/G06ohPOsmg=","vGpV76mnRzZEExVIsE5zN/R65oWh59pqEW10CLj/uy0=","w+5iR/XTKCKKCC0/ReD9z25bxD/k1107Oamzo9KEBoA=","wNucSvkGVgR1nYYij/p/g3hJ0HWJOziHuJeWtBlHEk0=","xCuMwXH4Ne+L8Fb8NgIoJ6Ctm/r74Bpn8T1QVsysEEA=","y2VLKhbYrt6ZwajKPa3GD/St0iOfmDVdTI23eHFfvRs=","ycui/78K4UTQd3NiMC8QvLYmhExwHmOgaSnADKqdfAo=","ygBstCHAXHCrw32N5iwboFPxsyhn9LfqnHSaPyOoLfI=","zccJLqYm1cZd1jfKYOAemx2z9aFFUol6ZmMa8PbDQDU=","zrHsC2+cZrvzq7HufpoyBA72RiFhH93FvmV3PAx9y4Y="];

var BASE_DIRECTIVES = [
  "default-src 'self'",
  "img-src 'self' data: blob:",
  "style-src 'self' 'unsafe-inline'",
  "font-src 'self' data:",
  "frame-ancestors 'none'",
  "base-uri 'self'",
  "form-action 'self'",
  "upgrade-insecure-requests"
];

var SCRIPT_PREFIX = "script-src 'self'";

// Include test domains so infra tests can validate connect-src values.
var CONNECT_SRC_BY_HOST = {
  "bjornmelin.io": "https://api.bjornmelin.io",
  "www.bjornmelin.io": "https://api.bjornmelin.io",
  "example.com": "https://api.example.com",
  "www.example.com": "https://api.example.com"
};

function normalizePath(uri) {
  if (!uri) return "/index.html";
  var raw = uri.split("?")[0].split("#")[0];
  var decoded;
  try {
    decoded = decodeURIComponent(raw);
  } catch (error) {
    decoded = raw;
  }
  if (decoded.charAt(decoded.length - 1) === "/") return decoded + "index.html";
  var lastSegment = decoded.split("/").pop() || "";
  if (lastSegment.indexOf(".") === -1) return decoded + "/index.html";
  return decoded;
}

function isHtmlRequest(request, response) {
  var uri = (request && request.uri) || "";
  if (!uri) return false;

  // Skip Next.js internal assets.
  if (uri.indexOf("/_next/") === 0) return false;

  // Prefer content-type when available (viewer-response).
  var contentType =
    response &&
    response.headers &&
    response.headers["content-type"] &&
    response.headers["content-type"].value;
  if (contentType && contentType.indexOf("text/html") === -1) return false;

  var pathOnly = uri.split("?")[0].split("#")[0];
  var last = pathOnly.split("/").pop() || "";
  if (last.indexOf(".") !== -1 && pathOnly.slice(-5) !== ".html") return false;
  return true;
}

function decodeHashList(encoded) {
  if (!encoded) return [];
  var parts = encoded.split(".");
  var out = [];
  for (var i = 0; i < parts.length; i++) {
    var idx = parseInt(parts[i], 36);
    if (isNaN(idx)) continue;
    var digest = HASH_B64[idx];
    if (!digest) continue;
    out.push(digest);
  }
  return out;
}

function buildCsp(host, hashes) {
  var normalizedHost = (host || "").toLowerCase().split(":")[0];
  var connectSrc = CONNECT_SRC_BY_HOST[normalizedHost];
  var scriptParts = [];
  for (var i = 0; i < hashes.length; i++) {
    scriptParts.push("'sha256-" + hashes[i] + "'");
  }
  var script = SCRIPT_PREFIX + (scriptParts.length ? " " + scriptParts.join(" ") : "");
  var connectDirective = connectSrc
    ? "connect-src 'self' " + connectSrc
    : "connect-src 'self'";
  return BASE_DIRECTIVES.concat([script, connectDirective]).join("; ");
}

// lgtm [js/unused-local-variable]
async function handler(event) {
  var request = event.request || {};
  var response = event.response || {};
  if (!isHtmlRequest(request, response)) return response;
  var uri = request.uri || "/index.html";
  var normalized = normalizePath(uri);
  var encoded;
  try {
    encoded = await kvsHandle.get(normalized);
  } catch (error) {
    encoded = null;
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/404.html");
    } catch (error) {
      encoded = null;
    }
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/index.html");
    } catch (error) {
      encoded = null;
    }
  }
  // Fail-soft: if KVS is unavailable/unpopulated, don't apply CSP yet.
  // The deploy pipeline syncs KVS immediately after the storage stack deploy.
  if (encoded == null) return response;
  var hashes = decodeHashList(encoded);
  var hostHeader =
    request.headers && request.headers.host && request.headers.host.value;
  var csp = buildCsp(hostHeader || "", hashes);
  response.headers = response.headers || {};
  response.headers["content-security-policy"] = { value: csp };
  return response;
}

