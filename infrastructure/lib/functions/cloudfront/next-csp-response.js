/* biome-ignore format: Keep output compact (CloudFront Function 10 KB limit). */
/* biome-ignore-all assist/source/organizeImports: Generated file with compact output. */
/* biome-ignore-all lint/style/useTemplate: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/complexity/useOptionalChain: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noUnusedVariables: CloudFront handler is invoked by AWS. */
/* biome-ignore-all lint/style/useConst: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/suspicious/noGlobalIsNan: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noInnerDeclarations: CloudFront Functions require ES5.1. */
/**
 * Generated file -- do not edit by hand.
 *
 * Generated by: `bun run generate:csp-hashes`
 *
 * CloudFront Functions runtime constraints:
 * - JavaScript runtime 2.0
 * - Uses CloudFront KeyValueStore for per-path hash indices (keeps code size < 10 KB)
 */
import cf from "cloudfront";
var kvsHandle = cf.kvs();

var HASH_B64 = ["+bEgLV2HgeUGx75Dn74Er4ojlfcKeNWN9b4wU8aBXLU=","/+GwKS8RMmXJVFHx50WyGF6HDz90wmJRJ5EMh3lkWmc=","0pvInhYlZm7RewoIRTHWg/DzvwKu/U2QbDl9oHdt//k=","14g3cXG4UTnEz1sd2Zr/WEBcZMZrBz9eQcqhnh4IljA=","152jtSE9F+BxstXwPFnZnO+f8oKiImbwTovxrFfddrg=","2UTcDAiEZSCg5pU79l3DjMX8qKcjo0rOaI6fompkJ6I=","2xGw6cmfq9ck3egHESHW+jlG+Vebw3wEf+niYWkr3t0=","3G3hKaqXB+rkM76wNTbeFKyGOap8hBuLTy/CjCx1p/8=","3O4YOTuA3jjrMtPnYgUzcPhkBlWIvvjRAvqJgFYTcQ8=","3aO1HwglNoNRAdrHsjvOr9Gcwil29GrLB2asVQqOmO4=","6V20kPkQzwM0VVqjSGLTeQq5vxaJd0+YKPodJUkv0LM=","6etHJnoBx0v9aCrvl/LdrRAF2jzoRHfR6y4KStIDTBo=","7mu4H06fwDCjmnxxr/xNHyuQC6pLTHr4M2E4jXw5WZs=","91NBBp0aQRDuAMwI/vu5vb90PHAW22v5pAY6hIrb/Nc=","99x91BTBztiheamDaovTgGc/LcPOgXEYxWu+6PAwxlg=","9buxjszFdjpWUljTLbePEui7iKV8CkOF93OutNp387U=","AFsupQJGsBY+zAfXP2knWZkhSybVlxn0i2htEdPJJgI=","BKR5jHlMDIDoFxKLlXCTri6UA/E99MbbK7T+V+Nekno=","BsJytk1oC6IXH23OVwJtsW+Yzsyucf0UVuWVroXkEoQ=","CA5Ribmngof4lVE2d4z49OCL51F/xcdyjYQaUfLX2ck=","CHQYzhlgVDBu/DmyGqvmc/C6OqkFEujr5ZDkfCdn42o=","CT2ktZrpGypLXNnrjqdJ9O6rhDmih7278eKWQ0cu/bM=","Cq8btV/vi++vKKRdDI+B7Dfu9Ij3qvxQzDG5pVSA0pw=","DA7QjyGVk1f+cT7xElezDSKXBeDkyE/Y4k5hmAWdkdk=","DUUitAe2U9TAjlFK5oH4iNs1bi1zwELeglcOz28uQHU=","EJIacmeTuJcrkWeEp4PTrO+L0x85MZpKaVMhGlecqMA=","Er956Pf61oV4rVxE47P5q5I+bv0ZfdG6yHQXmOqxPoA=","FGZJ+mMG+dzpfOZvCXV+jJm0p/02nD28vGZQeHimKQU=","FxI+W5dgL3VVPTmjAV1jT4SChe39z1wxV9bLQDP2Rro=","GHwYtkVTEbLWum3YqPEcDYhllFhVrQTVMmK781RIWh4=","H8lQajQRcLaYdLwyY6KEgsOzFVlA73sPR/t3MEYHG7I=","J9fzR4xQ1+7MgJy0M2wXXSlDnp6VyJrrzMkc1NtxM6Y=","JMrVei7dLewkbqa/oEhFdzUKVKVNKeWEtV/WXYkQ37o=","JbuuplqZ9KZxN/teHCkmLOfbYJj/rzhD7OFEcfWxPG0=","JhaM0d5/4O/WynV98/LHy/Mzccic6JXzrlf5sNB+9og=","K7LhdNcCAsxDqAJdZYLAd9msP4tZg3GAMAMDaos3hq0=","KIGtxZlOix8TqPwPuQJQ//bP4xhw8/XtZSvFbUPHlZA=","KKqy0/hb9kry4aIEjVN+AW4MpRhtVSFHN3HRnpXjvfc=","LFLsnDBjJ7N55uXKcpfJDNFdf/+KUj66Pc3j/iiGpDk=","N02gG8c6Lzh1BUtVKiqUC4I41VotkGh26OovA9mMymE=","OBTN3RiyCV4Bq7dFqZ5a2pAXjnCcCYeTJMO2I/LYKeo=","OVBifIYiG5+s05dWZNHmtxz6zBRb9d5vQZZAeYt4ogc=","PYrSCKBr0oxx4yW/tJehE4oav0mCIUOvh5xLsRzAR0Y=","PoUmiMVMVwMf3kHf+nIsGO3wck5fg8DrruuOLs+3+Sw=","QAlSewaQLi/NPCznjAZSyvQ72heD0VdxmNDDkZeCxgc=","QD9s9w7owX+gU8edvM8JFzV2FvWRe41TDvU3h94pIrg=","R/rFn5H6rksWYIZeSy8kn90WthpVvohJNTthnvFlFpk=","SsAiqdNaqOz0NdynhBjjZ6UgklReJmGNVo8jx5lThtA=","Ua3rtH/OkdkrpC64PfyXrfqS0mb1aIOEuIJys4fBg6k=","UfXOPgMgWXgVAc95Z63cpb0iBb05qzjpUP2QK1eM6qU=","VWlVs7SAlpMMZDKbPM29cAr54iaUYHxtdVMsiCSi4lo=","Wjqd1Z8focuJg6nrRg7QV2NMuiQrCVK372w1qVXVJ+c=","YTo6DFwRXpEKc2K3XYa3GT/RWnU05Qss8TKusWQy1kA=","YpuuijLSzD5bh2KGxZqsIFvRjo64IGNf9QwNRdfyhn4=","Z/8yh2gQKwL/ML6uuo/O/+tLjFcPQBveGlMnQCFrYec=","Zh0fmOwSiqZ/Ia8wqnsuU0dQDc896NLr01y4LPPiF1E=","bvohpmMnM6bqe8gOMDGQOOtU+s6Iz4rjCUSJ9ctNy/U=","c+LqBZyrZGg707ci19vOA1VTh2QxCewllvOY26syDSw=","c1+02K2VM94Z93qi5xmzfMuebFOzzpD65VVfXtK1XTQ=","cL9jmtKpHqgFzGugh/AMHp00W5W3AE2BjiOhxEI/Pe8=","ctLQVDf0ehdhKY9CYu3XNzz/MuF57PjlLuvuMjz7gtI=","d3nW9C3MVxwZovx8p2NB4VQN7PEQz9hi6K3ATZJxnbY=","eO5de2zEsL1+jchUhKZVMQrAJDANnPRR9bpC9kXENeY=","egYRgHXtBHY99JA82Vs+AKbYvaGECRQ46J34dbg1EtI=","eoVSr1RSYYcnZ0h6bcmq9ebcObjQ5gbo8XIrKACucJ4=","fdqtkOX8Dgcru/RWY+EAKiVICE3YCYd+PqgRBO5AEAM=","fm0qKWqyNb6TiMJxTaGhB7SF3+OJwCoJFxS9IHKCCOE=","h4+X9AV+OlK44McOkx7hjtZw72dU9WZAmwPsrHkmeYY=","hCF15Tr2/9i4D8W1N2gsIG68cEqhwGMZRAjJ5jHgX98=","hTPaoYI6JyMgRU/iU28TE9mFh5NexBD6oMI7nlAVtSc=","hc4DclDp6F5WARnzeo/huGEmTCd0UHqT5YMZOW0AztY=","hzZREENScTdMB+Wh2YAEMLTMURkf7Vh9GqmVKTCdtPY=","iJVwjUWYhzeq6LbzCUBckBH6+Ey00rFYZbThdgW47uw=","k2QZFq8tkAMoEUdmG9MgYOfx9sFFHvIIqvroIArbmSI=","kzj4r6vzMc/sfy0/x23bzj1Dpm4bxtAs/+DAo+9VLLc=","l7Jx2nHWfgvZxvpIE8PBJKOjY3glX7VGc8x1SH7OBbk=","lLu2ztmFXg4xd7QBgA89m80OGgXKcElg8Sj0eqopqfs=","lq6qS6wKLhA17miBhD/mZ+ZEN41z4YstdPvTE0rB/wo=","ltBh57lu87N6cINyQ7MDYPoXoYulNw4GJSWPGTQAO3Y=","nHOPkpJUDbL0z2JDO4q2CYiCFWlbzyMpwp4oCC5E3KI=","nWZnHy9c9WzOusTQTRaH2H2HLZW7+Fsmkw0ZX3I+ai4=","nn5CZUSDT1m/8aHw/ZWtg9++gfXrkGJBTyU5FXRNq10=","oHAhhPa74+EQABIVD8izSvEcRVZU+WGAPjA50vaBcLY=","oQM3CIHswto9zjdkpLWIig0dNw/ScQUK2d7GAXoExeE=","oRRoAIvYkqs+NuMA99q7OjNuKw8iBS2QDY1TCp9+jX0=","obyT/TIP2lVtlZunP4LnGwtcqMd1ZDcdUnaIixk44Wc=","ppncqXtC52/RLC8LWRJ363lOaTVGuuF9ZR8eizWxEZY=","qzFF7EqXlcg7nbgTTxXIL9zqk405QQfBFawpEh2dxao=","rK1+SxvLstGbjEoBN+f0lq7JVAksLxLJQcQhjpkoAwk=","snpey9m99r5I8j3jsdnWSXNTb3tQSSoiBU/kjgNiKBA=","t0VVnHGFyn0fpIEiPGwtM5cFH11EZ/wXsKQE3ckYVl8=","tEE4uPac9mHOFH9YAgY8OnTcXgOTd4qMz3X93QLw7TI=","tENbKDDxq5o4am7N3PaWSK75wt8gJ1Fz0iwoGt73upM=","tW+cDhPLj8SxDcRCyoOHRnKVAyNXIBMYNAd7uBIUtAs=","to8dZWqy9t+qC63j49/CxxXRxmuxmn+XCx7x3LE7mlY=","u2YqR2PhoH6VwKt66kpSQOpvLApYgU9GwAgp82uYXJ8=","udmcmh9tcLfeFyIPmEcvYj0quRfXwPcOFlzBD+2mscY=","uem4EkJujTHeW/D2E/QvmZy78HxvxPBN/G06ohPOsmg=","vGpV76mnRzZEExVIsE5zN/R65oWh59pqEW10CLj/uy0=","w0CMBVOCdkQH0zmTsBaLGpMopS7V73biQ2dLBDaOr5s=","xHDaqElzmJhcWhHCk97xPTExz4W1z/+0e7lW5s861sA=","xIgvKyy6i3plKe3Fob+oqDVd37aMI6gWx80PXT5GQgg=","xUc8gkN8Ln52DJiXborVfKA7yDXJuGCAQn42JS+rdVE=","yI2IdZ/f2cNQc1d/dJfgyA+bcntLdflfYBzds2e4wTI=","yNyiOkfGcHe84KZmpNpv8qb07cx9ks4qNi27hWtCyLs=","ywVcH5Wo6c8q0v/3+72uKViLwzy51UXBBApPQZkELBI=","zDQCAoblBxNvPEXH7LMKj4zZ2SyXLUunapB6wMl9eHs=","zXDcND5f4p2y150OHQ8FGI0kKsSh8nklh/fw9hnIvCM=","zyDGeE9mMCzEGvGyCOt/w+2y4lS8Gd2QQHoVKbFx9SQ="];

var BASE_DIRECTIVES = [
  "default-src 'self'",
  "img-src 'self' data: blob:",
  "style-src 'self' 'unsafe-inline'",
  "font-src 'self' data:",
  "frame-ancestors 'none'",
  "base-uri 'self'",
  "form-action 'self'",
  "upgrade-insecure-requests"
];

var SCRIPT_PREFIX = "script-src 'self'";

// Include test domains so infra tests can validate connect-src values.
var CONNECT_SRC_BY_HOST = {
  "bjornmelin.io": "https://api.bjornmelin.io",
  "www.bjornmelin.io": "https://api.bjornmelin.io",
  "example.com": "https://api.example.com",
  "www.example.com": "https://api.example.com"
};

function normalizePath(uri) {
  if (!uri) return "/index.html";
  var raw = uri.split("?")[0].split("#")[0];
  var decoded;
  try {
    decoded = decodeURIComponent(raw);
  } catch (error) {
    decoded = raw;
  }
  if (decoded.charAt(decoded.length - 1) === "/") return decoded + "index.html";
  var lastSegment = decoded.split("/").pop() || "";
  if (lastSegment.indexOf(".") === -1) return decoded + "/index.html";
  return decoded;
}

function isHtmlRequest(request, response) {
  var uri = (request && request.uri) || "";
  if (!uri) return false;

  // Skip Next.js internal assets.
  if (uri.indexOf("/_next/") === 0) return false;

  // Prefer content-type when available (viewer-response).
  var contentType =
    response &&
    response.headers &&
    response.headers["content-type"] &&
    response.headers["content-type"].value;
  if (contentType && contentType.indexOf("text/html") === -1) return false;

  var pathOnly = uri.split("?")[0].split("#")[0];
  var last = pathOnly.split("/").pop() || "";
  if (last.indexOf(".") !== -1 && pathOnly.slice(-5) !== ".html") return false;
  return true;
}

function decodeHashList(encoded) {
  if (!encoded) return [];
  var parts = encoded.split(".");
  var out = [];
  for (var i = 0; i < parts.length; i++) {
    var idx = parseInt(parts[i], 36);
    if (isNaN(idx)) continue;
    var digest = HASH_B64[idx];
    if (!digest) continue;
    out.push(digest);
  }
  return out;
}

function buildCsp(host, hashes) {
  var normalizedHost = (host || "").toLowerCase().split(":")[0];
  var connectSrc = CONNECT_SRC_BY_HOST[normalizedHost];
  var scriptParts = [];
  for (var i = 0; i < hashes.length; i++) {
    scriptParts.push("'sha256-" + hashes[i] + "'");
  }
  var script = SCRIPT_PREFIX + (scriptParts.length ? " " + scriptParts.join(" ") : "");
  var connectDirective = connectSrc
    ? "connect-src 'self' " + connectSrc
    : "connect-src 'self'";
  return BASE_DIRECTIVES.concat([script, connectDirective]).join("; ");
}

// lgtm [js/unused-local-variable]
async function handler(event) {
  var request = event.request || {};
  var response = event.response || {};
  if (!isHtmlRequest(request, response)) return response;
  var uri = request.uri || "/index.html";
  var normalized = normalizePath(uri);
  var encoded;
  try {
    encoded = await kvsHandle.get(normalized);
  } catch (error) {
    encoded = null;
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/404.html");
    } catch (error) {
      encoded = null;
    }
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/index.html");
    } catch (error) {
      encoded = null;
    }
  }
  // Fail-soft: if KVS is unavailable/unpopulated, don't apply CSP yet.
  // The deploy pipeline syncs KVS immediately after the storage stack deploy.
  if (encoded == null) return response;
  var hashes = decodeHashList(encoded);
  var hostHeader =
    request.headers && request.headers.host && request.headers.host.value;
  var csp = buildCsp(hostHeader || "", hashes);
  response.headers = response.headers || {};
  response.headers["content-security-policy"] = { value: csp };
  return response;
}

