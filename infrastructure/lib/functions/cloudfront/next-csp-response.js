/* biome-ignore-all lint/style/useTemplate: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/complexity/useOptionalChain: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noUnusedVariables: CloudFront handler is invoked by AWS. */
/* biome-ignore-all lint/style/useConst: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/suspicious/noGlobalIsNan: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noInnerDeclarations: CloudFront Functions require ES5.1. */
/**
 * Generated file -- do not edit by hand.
 *
 * Generated by: `pnpm generate:csp-hashes`
 *
 * CloudFront Functions runtime constraints:
 * - JavaScript runtime 2.0
 * - Uses CloudFront KeyValueStore for per-path hash indices (keeps code size < 10 KB)
 */
import cf from "cloudfront";

var kvsHandle = cf.kvs();

var HASH_B64 = [
  "/+GwKS8RMmXJVFHx50WyGF6HDz90wmJRJ5EMh3lkWmc=",
  "0FkH1DaJnEydO6QK9qoqTU+VWUWwewF6ZY9q1Y1SBhc=",
  "0ic1IqdscurI4VKjBOvhJ/DvuvzYFRfVsWSWj4/3xpE=",
  "15+e1p1BVFXy6TRmQxNCmT8Sq6+qGab27BzwDNcFreI=",
  "1CPUIJH+j8ghN5fWzmIpPpyBp+VzKiERFMaf5W4o244=",
  "2Nv8B8plWChepM+0S72+HX+E4Uo7ccnjeNtw0sC7xvU=",
  "3ncRmbykpqITpwZBbEQCTCMRs2UGL+zAszEpUz/tj94=",
  "4Gwfrx37YElkPUHm5+Qpda+na9/Bo0CtUBXbQRU+RiA=",
  "4JpkDzvZn2s9TOXMh4VGBBBR1wFHIgi05xikGJnYgLw=",
  "4UhFmNVED3P4rBkxqzQkG3UBuy7Y1SXHMr22uGHyJ9Q=",
  "4XkghvSPspoIijZUEySvcc53RS5Z5QIuL9ysoDesljQ=",
  "5MsGM9v4ULr6ObZAV3722H7EhdrW3pG3FfvPobcvB7Y=",
  "5kliCkkDfqhPFACb3WFtUaJPuYnBIRh+L6noN0fad6U=",
  "6SfKOD0clWxBmZiWqpuxpWHGVazA7QdeT9rN126LrwM=",
  "757W+zDxXJta7RISVA/d+7ikVB7XmnBtBI9oBgn+2sk=",
  "7CjW1QhnY0Gs6ClRbQsRHJUrzFwLNonntl4iEJGVx2U=",
  "7mu4H06fwDCjmnxxr/xNHyuQC6pLTHr4M2E4jXw5WZs=",
  "7y2oru+ItVhQq5m5cI0vN8y5aj8N3E+352UZf/EdZ24=",
  "8oXo0TYtAiN01NyE2ShEHsNbusLAPnmDRP3TTD1ZCmI=",
  "A6vjDUZ90aTgWkQ84rOxw2lszXK5haFv+kji58idLJA=",
  "B5JX+arDSUK12lIpW4mbOMzxQl32G8edSDbuJyKyEjc=",
  "BzK873bmUmhArliR+W7EkYtbR47dYk5zeRMB4SvH6C8=",
  "EK3qw1FvbGAXkXjn6aruCxN6dGLaKJajVFYhmq2TuCk=",
  "FETXtEMDwdoNHOckvHNvjQFOAxc4OhUJeP+WdJJmdRY=",
  "FGEvVmaMOUnZI2MVfxn6kW5RgNgTQm9sMr0vvdGhrnA=",
  "FxI+W5dgL3VVPTmjAV1jT4SChe39z1wxV9bLQDP2Rro=",
  "Hcfl0epq48zYTajL6ROP4HweVyG0xWkWFnjoPu2tyns=",
  "Is0u7xvDH1MEXkeyJAsycPQ0w6FFYT6tSi7va/EuFvE=",
  "J5nl4uUnCHapFV9LD50oogerdEvJ17PQ5rhYHbkeKaI=",
  "J71QnsUML8NxfeE42NXMLswMVAIxO4+Iz4JT7DWpt1s=",
  "Jh2TsWMITdyMU+iRqlw6uJWXx6XvXryKkZoXocMxg00=",
  "KUD91aKloJunb/i7gvPoHkPS4KeVgUeuV2JCelyMT3U=",
  "LDLUHmqX1MdB/FmYwCwkpxka9ianY7jj/tfWj/8y0YI=",
  "M5MJVEx1pRti3czZOZDM+XW7/zG8IBBqZaf0j+f46lQ=",
  "MgFuChwAPOlxa09+yA808RO3TCTQeY2cU1ykM+owK+0=",
  "NYMKKSpRPHNY4PZLkNxZakaN2C13MbwsoPtQQh++Dd0=",
  "NuzMR78MDBvH+HGx/T2Sm3O6vVXQ7C9XsQAN11wrok0=",
  "OBTN3RiyCV4Bq7dFqZ5a2pAXjnCcCYeTJMO2I/LYKeo=",
  "OkEAQ8oivbXFOS83i6hPdwl+Joy6Diofjf7dFObDM4M=",
  "P2pfPe4iwzRczTv1V/szDn4W/dQawZ4s+1K9oSXA+2w=",
  "P9Pqmfti8tG5A4M0/L0VgxvWweWTLvj+Dws/8SR25lY=",
  "QAlSewaQLi/NPCznjAZSyvQ72heD0VdxmNDDkZeCxgc=",
  "RIf83i/u7VcXsOML119pEU/XiKU4+2FwMWExdgjXnLA=",
  "RSOgGjy5MjPi3Nusv/VDwdV8vyblX5bABQ5q1XhzxHk=",
  "RpOWCZ++Rw+6w4HeiI7wppidwnZ7OBrkoQof0vHzN10=",
  "SL8tNaaMr8aKIGDKFC5JwLdpoFfZQxYN1QtGUefOgQs=",
  "SicR/HVbCBeJIsczRcrdFsp1a5XdC7IhQAKxEOJyBAQ=",
  "VFJKclxO25Rj7akaZJeYqaJv490oHBRTo4P+VLNJr54=",
  "VQtE6d2+QqYwrPlpJLQrDRj85D9R1pG0CfWPZeHj4Os=",
  "W8ele/1TR8WBPsx75+b5OLzYZNqW3FXBTPA+1ccl7cw=",
  "WA/zlKtyLXTje6Y8BzZLboxi7p0VVAYuyk3fRf/Uv1Y=",
  "WG906wmCEmH+bBCdbmH5tFtu/c1kqm9fKnIEH9jdPgY=",
  "XZZmTWaryaMD/pb/+MbJOU5RArdsgv2k6NhMukw7lqA=",
  "YCD7jr7owaSnlWvWgZTlPh48iZOr7hZ5Jbke51vfEa0=",
  "Yf/iJv/5gSiO5oNsUvq246AHV4FU4naO0nwY6GuKlMA=",
  "c/dZMBnhowgL5y6XOgy2KaOAHljK5e0UnZGjxo/ta6w=",
  "cmfAZZoeWQfQy54eN7TSPkbGXNWyn4fEer/0BNz4R/M=",
  "d7M60TAQYBgkvTF+oX0lT+828MNR90VNBkVmmaWhNNM=",
  "eIXX20/QtBq5kMbFrgZRSgNiDFwIHrP27W4Vp9PUv58=",
  "eeI3CiG6AtHN2rV25Y8JVV1JV3MsbfSpGC4quH+Gq6U=",
  "eiCUaaC1PQyBLK5/Z4uB1J154nUht8nUdp1fPPF+zoY=",
  "fTw7y0v/pdPFkkhy/UaOCBqUTW0CMMlI+axG8tuewn8=",
  "gakrOPDsGAUU6PcvtbdhJqzeQVvkNFLrwMlfALv2TFg=",
  "glf9m25a9dWQk8oobPN7e6G1KC5vaJ5MjjM4z7qtc/I=",
  "gnDPPi+Rc+5TS68YgHAgsTjCBmJh1KUwoXxGZKyi+BQ=",
  "hIdPRqGWioE8zq20hkIagvPDQzJWn4PilN9eg+7V8a0=",
  "hej074gQxrtCzu7Wv7aqsLqxvc2RrjzwOwZ5btPT1Po=",
  "i9pskrcC1nY6XQ0+R50Q5ajY7niLYVGFgv6XZj3ydeI=",
  "iUyuxuHaEZok09DTpHlZ/eMm4mY8XNSzeqiW7UsCLao=",
  "jaQaLicEzOfRHZ3yS/xEP/IWvHJ8CKHzFTK1myWp+eE=",
  "k8nFaLU386vO8hvPpxkYiPtCFzcbzSTp3Hu/ErdKIr8=",
  "kYM9sHdKF9Y5WP2Xz4Vz9w5kyY7YLNWM/04F9LO1VOc=",
  "l+yErm+ZCt8J9HeKlN8LNPdnNixbRJgGDFiTk5f/580=",
  "lqHIvxzGXYNhjC1n0PDXAHbc2KQ4p47R4PGPqOfmKvc=",
  "lyml4jjfS91HOyYpaavCSvHJSu4OUiBsogrfs0FUNws=",
  "mQi7OQ0qQW/fN32wXcz6Njl28eloOh56pH4g6BFX+H4=",
  "mmjYqFj6zqK4y0U0fqTkjUi2VeUId8Qt1MxOwnBBEcQ=",
  "nNydWDeixY+IR4rTm/xpkbzXZKqJqtb0chvD31XEcOA=",
  "nqrIZiB4g5HvdybOGaj1Ky30FbCsMe9nbRItQWW1E3w=",
  "nrPt0axm6yxPdlAweaaiko/uiewjbLYiKhszdgu1S24=",
  "oK65/Xo2pTHB4NjU/Eyl2HZulY4490IJK1hwsKMkTic=",
  "oOqWZYy4A60iJLlyITNRQqpMtr5mtsQGyBf2cVmDWNQ=",
  "ox1vo8sWdwE2+YS6jiML+0XsY3sNMLts6Arsgbbx/8U=",
  "pZejXRlm3SaG3qyjMtGAD0W4AP0HE/ZISM/JLjOxwrY=",
  "pl6iXW3h5YQxetLyz4f+J9bhSHH4ui3xJ1l+ukuzn+Q=",
  "ppncqXtC52/RLC8LWRJ363lOaTVGuuF9ZR8eizWxEZY=",
  "qJhJQhEbUaI5vbAv6bm9LufH9dHUZMsgj4wZ9XMkXtY=",
  "qXodLOKfpG/a3/Orn87nu5A6ItPlEye2AERm7OaL00o=",
  "qeUMmF7rg3IuYGXW99AyKv1Upt3lbj2Gd3g4uDyh5hs=",
  "qm2KFmFDvC5Xr6d53K40E41cgs2VBrfgmkQ06dijRRg=",
  "r39zmmk2DV7rlSFKylZ6dg2aoqgIgESrXLCi4NB4kMs=",
  "ryFhYrloNuIY7tbXRikQoTUQwUemnGBh9pHZMRGiKF4=",
  "sH3gaGtqTjyn5aiLZBOLXpsC4UvTbCxU/8sxXDnmwj8=",
  "slvoZoASTyBR/YWKEiWemWuSubPTBCo5POloiJw3dhc=",
  "t0VVnHGFyn0fpIEiPGwtM5cFH11EZ/wXsKQE3ckYVl8=",
  "tr3mU4oJh7SPEerej02T1rs2EawaXC4n7NCvw/x4uFs=",
  "u2YqR2PhoH6VwKt66kpSQOpvLApYgU9GwAgp82uYXJ8=",
  "uBUah6fsUdxasVWcVr4IxPzP+umuzSthhRwIWhvoiFE=",
  "uOGa22LXtMShbqChSljN0r7M5GHUvuB45SbH5pu9ywA=",
  "uem4EkJujTHeW/D2E/QvmZy78HxvxPBN/G06ohPOsmg=",
  "uwWchwmpZRGdYCdQPYxYIYykz9VzdBCr4X+OQEAs4ck=",
  "vGpV76mnRzZEExVIsE5zN/R65oWh59pqEW10CLj/uy0=",
  "vIPipsxmr60TknbtaJQzqCfQw8q+YstbpRawFt++INo=",
  "vc9sy5Xlp8TenqTC07oPbxAblg1YVItiKWrRo3ecnlU=",
  "wPfYv1zWHlX1qw6lUtFLmo1yPMJ3F1+lrhpuyAamviE=",
  "wRApOBxr5vFX6uQTqfswlKwh2VXAJjvawPY0WRzNBNg=",
  "xQRNT7X+66On4F8vAdPE5PVMYbD1IKhZeHyO/PDZQiY=",
  "yEGaRrYGpaxm7ARgPhiBntsg5AEev3cCwpB5XsXLJf4=",
];

var BASE_DIRECTIVES = [
  "default-src 'self'",
  "img-src 'self' data: blob:",
  "style-src 'self' 'unsafe-inline'",
  "font-src 'self' data:",
  "frame-ancestors 'none'",
  "base-uri 'self'",
  "form-action 'self'",
  "upgrade-insecure-requests",
];

var SCRIPT_PREFIX = "script-src 'self'";

// Include test domains so infra tests can validate connect-src values.
var CONNECT_SRC_BY_HOST = {
  "bjornmelin.io": "https://api.bjornmelin.io",
  "www.bjornmelin.io": "https://api.bjornmelin.io",
  "example.com": "https://api.example.com",
  "www.example.com": "https://api.example.com",
};

function normalizePath(uri) {
  if (!uri) return "/index.html";
  var raw = uri.split("?")[0].split("#")[0];
  var decoded;
  try {
    decoded = decodeURIComponent(raw);
  } catch (error) {
    decoded = raw;
  }
  if (decoded.charAt(decoded.length - 1) === "/") return decoded + "index.html";
  var lastSegment = decoded.split("/").pop() || "";
  if (lastSegment.indexOf(".") === -1) return decoded + "/index.html";
  return decoded;
}

function isHtmlRequest(request, response) {
  var uri = (request && request.uri) || "";
  if (!uri) return false;

  // Skip Next.js internal assets.
  if (uri.indexOf("/_next/") === 0) return false;

  // Prefer content-type when available (viewer-response).
  var contentType =
    response &&
    response.headers &&
    response.headers["content-type"] &&
    response.headers["content-type"].value;
  if (contentType && contentType.indexOf("text/html") === -1) return false;

  var pathOnly = uri.split("?")[0].split("#")[0];
  var last = pathOnly.split("/").pop() || "";
  if (last.indexOf(".") !== -1 && pathOnly.slice(-5) !== ".html") return false;
  return true;
}

function decodeHashList(encoded) {
  if (!encoded) return [];
  var parts = encoded.split(".");
  var out = [];
  for (var i = 0; i < parts.length; i++) {
    var idx = parseInt(parts[i], 36);
    if (isNaN(idx)) continue;
    var digest = HASH_B64[idx];
    if (!digest) continue;
    out.push(digest);
  }
  return out;
}

function buildCsp(host, hashes) {
  var normalizedHost = (host || "").toLowerCase().split(":")[0];
  var connectSrc = CONNECT_SRC_BY_HOST[normalizedHost];
  var scriptParts = [];
  for (var i = 0; i < hashes.length; i++) {
    scriptParts.push("'sha256-" + hashes[i] + "'");
  }
  var script = SCRIPT_PREFIX + (scriptParts.length ? " " + scriptParts.join(" ") : "");
  var connectDirective = connectSrc ? "connect-src 'self' " + connectSrc : "connect-src 'self'";
  return BASE_DIRECTIVES.concat([script, connectDirective]).join("; ");
}

async function handler(event) {
  var request = event.request || {};
  var response = event.response || {};
  if (!isHtmlRequest(request, response)) return response;
  var uri = request.uri || "/index.html";
  var normalized = normalizePath(uri);
  var encoded;
  try {
    encoded = await kvsHandle.get(normalized);
  } catch (error) {
    encoded = null;
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/404.html");
    } catch (error) {
      encoded = null;
    }
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/index.html");
    } catch (error) {
      encoded = null;
    }
  }
  // Fail-soft: if KVS is unavailable/unpopulated, don't apply CSP yet.
  // The deploy pipeline syncs KVS immediately after the storage stack deploy.
  if (encoded == null) return response;
  var hashes = decodeHashList(encoded);
  var hostHeader = request.headers && request.headers.host && request.headers.host.value;
  var csp = buildCsp(hostHeader || "", hashes);
  response.headers = response.headers || {};
  response.headers["content-security-policy"] = { value: csp };
  return response;
}
