/* biome-ignore-all lint/style/useTemplate: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/complexity/useOptionalChain: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noUnusedVariables: CloudFront handler is invoked by AWS. */
/* biome-ignore-all lint/style/useConst: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/suspicious/noGlobalIsNan: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noInnerDeclarations: CloudFront Functions require ES5.1. */
/**
 * Generated file -- do not edit by hand.
 *
 * Generated by: `pnpm generate:csp-hashes`
 *
 * CloudFront Functions runtime constraints:
 * - JavaScript runtime 2.0
 * - Uses CloudFront KeyValueStore for per-path hash indices (keeps code size < 10 KB)
 */
import cf from 'cloudfront';
var kvsHandle = cf.kvs();

var HASH_B64 = ["+KjQd6psLyWUiDTlyp1RqtM8gndH+zLvZaLWTd6abtI=","/+GwKS8RMmXJVFHx50WyGF6HDz90wmJRJ5EMh3lkWmc=","/lGmDMa5F/xqrqYSNgtAhmpsGHVG73bxJhyA9louyBk=","0XArOXbUKb0xjkAl2tWd6HIBKmHNXAa9nDjfuTYl2/c=","0nB9isUZMLLIj5+k0rsJMfSbHGuO80tTUlMUZNSyiDI=","5gsC5meZkViG2LT09H3k5q5/IZrRaryZWpWllm7nzIk=","6a3nmAUVGRvkJzM7tZARtat2xd2fSpqNrXrrXUyC4HE=","6kZJGB0ILOncGGJGhAh/AS+RF0BTIqHMHg/RLLTnYBM=","7G+0Pz82Ddosv1ikIsUP9j6lhrYS35eck/X3Vh2bYUU=","7mu4H06fwDCjmnxxr/xNHyuQC6pLTHr4M2E4jXw5WZs=","9F/EJQMyHzcTFLcg7QmCIhPzUe8nwNGZPOV/wCAXFNs=","9cspBNvxW6BrzApZKt1QK7+e1JBxzkO262o+4lU18Lg=","AaOAPlUA9J39b9vt2Y9lmO+A+tIrWMCSi8TSBRx2OHU=","C5d2earp+069UtISKKu+MU9wyXJmuA1UjEYK2bJ+IKo=","CCoEm9AXhRNzlRIPt9w5XVk01eaCnnB8/IP0hfIxqQg=","CRusmLMEW/8FfnIqn/q0/LOurqtfVfTu0KDY7eU7WDQ=","CTDRpFllc3Y61drgWIVVhrixlESTtQkXU22KQyYGC0A=","Cq8btV/vi++vKKRdDI+B7Dfu9Ij3qvxQzDG5pVSA0pw=","EYHbbv/VP/77t6CWSOLVvDpJ4Ve5XT2/olLpkpXiHSw=","Ez0JMWsoDEdjI0tWipCKApy3yBJ7W9f7TQ6pO5w4ORo=","FxI+W5dgL3VVPTmjAV1jT4SChe39z1wxV9bLQDP2Rro=","GZllLf62thRtVagbH1DvWaBT/Pta95E+q1lPAu6Lqcw=","H85IIansLYXhG0jjCb7WKF3DE2/FVNQRFSEkTLV/vAg=","HI9nTstKlmC8sqWDuMUoxfq+eMnjKJe6NyilX9NC2yk=","JXBGhirDmlZNg6k3qsdFLhpof/2fIQtfhnoCokQ8Mok=","JcC9QCAsSeLFGoTM0rYfIgyc49blcuFx88nSSUydRw8=","Ju4MPhKGUUNmAVbNWjV2WCaf/EzXg63cKBEO5b2xtnE=","KdmI1LQ6ee0E15W/3BNWk1EtNoGTd+WiKUC4hcvJN6I=","L8AvlrB97T62Xg/jD/Dniz1Wv0x5wkK0RaWDw8XBH5g=","LC6yMjC61xsl8PlUeuC9i49fQWPv52dNomsV/YtmeRo=","NNox2+YnzhUYE0YV5azUu5EFLsSLmt+owyVUgtFZ2QM=","NmpxgUipG0+aFTo+NJMiIyKyOVNKBiOd+P+m6PcIvfI=","O6BQMYZW6aQna8hOw2PpfCWiYFQ+OlyYuVi4wdHo0TA=","OBTN3RiyCV4Bq7dFqZ5a2pAXjnCcCYeTJMO2I/LYKeo=","OJiphI9dsaJN1K086mEjY7Lcta0KIcBsub2/FDxCYrM=","P3ezet0MbdUnHPt+0Syk5SRsEcHFi2hiahkKnhw8h3Y=","P9Pqmfti8tG5A4M0/L0VgxvWweWTLvj+Dws/8SR25lY=","PoUmiMVMVwMf3kHf+nIsGO3wck5fg8DrruuOLs+3+Sw=","Pordtjk+p+52k0t7bMLNcDrEYFSQ7VHSR93IctN9Qzc=","QAlSewaQLi/NPCznjAZSyvQ72heD0VdxmNDDkZeCxgc=","Rs/grT6ZKoD+lF9+aTFCoLdO5Nihf2guMHWjUIq7jB8=","RvBoH5Graf6hn7h2l1SYnnLd037bkAakogqZgIidLIY=","U4xlVPKlJN820Z/Ox0t7AWOPrlc1u7tmfoQXhr+4vzA=","VEhOVGYxeLDmTivjTFW7cu3ostASqSrFxXj7N1Fso8k=","W8ele/1TR8WBPsx75+b5OLzYZNqW3FXBTPA+1ccl7cw=","WX5vyNDoUgIECJDsFg3D8NA2WEUgLiyDRkK+tRg8hJ4=","WtXifAl1KtLmbbdXZFvTLiC8iAW4nPNL8Xd+JpGnd1w=","X3Ktdb53+5SHBHlmBnzHmZFdS/8XRmh9wC2KsbuHpDo=","X6NoTikcgHKeEZ73NVaC6aoiyy8E02cxBn7s09KtD/0=","XVZcecpM/mdrbQGMAJ6LWWPgl+y/odN/buLKKhrtOK8=","YTh1TWsWUWCrtL3Uz2PsZ9yHtccP046m11G8WWcTfjA=","Yf/iJv/5gSiO5oNsUvq246AHV4FU4naO0nwY6GuKlMA=","ZRco5nAnb+z07jtChgtNL4EETN2NYCOWPMAVZvr6D5g=","ZZaarBhKP6xN7C62dh3yuNi8ZdUnHz8yVy04K7JNvJI=","a5TL66lQuu/HSIqk2lBQ9yZWeYT3hd68b6i7+zSZ51U=","aCZI7pePVyQsGx3LCNW1o9hbklrPZTWGnIZ8nrGj2ss=","aL29xglzCSBxWwwQNS+wCIrBCVeTfqyjr+QVLpk1LOU=","bL+pT3lzR7ZFJLIP+YKamX7Dsar+hKJjysr0pqw0suA=","bYA5bbgBoMktiTOgTf2KVOg0v1jxaFZNaovYhgRGN7I=","bdm7wDZHh2N+/uAVYB4jW1hsqMK0l7S3rRSYfYI2kt8=","cmfAZZoeWQfQy54eN7TSPkbGXNWyn4fEer/0BNz4R/M=","eoVSr1RSYYcnZ0h6bcmq9ebcObjQ5gbo8XIrKACucJ4=","fD60d9CvEpMsgzxApCtczusxH4X1YFGemJ3F0rcM3AU=","fd6wFuM4TkzR9Ddu7XMl4EtuCVp3Q6gwySmMG3+qUXU=","gnDPPi+Rc+5TS68YgHAgsTjCBmJh1KUwoXxGZKyi+BQ=","gvpuAzWXVCfJ0z5kAy0v39SyL9TlvP5nxDfU7fgEIwI=","hC/DjRbo2qkpIiSTJeo9vmMDdG3UtnkfwDLjIiAy2Fo=","hH8VBEwATdyzXH7FZBDq8MCb9Skcj8oQuJUgSJ8+o/M=","hmKsr33yzkUdHT7MI6PYo+RwAgHuAcx5CbjFrD8C7Uk=","iJVwjUWYhzeq6LbzCUBckBH6+Ey00rFYZbThdgW47uw=","iNXUnbD4pAEsAtULOC/6PxUBxtVN8yVKPn6v8HvMmdo=","iQW+NvaNGV9RCFm0wBvNQN+XRWoQItvnjfSD6Nre8S0=","iUyuxuHaEZok09DTpHlZ/eMm4mY8XNSzeqiW7UsCLao=","icUdFZGqQU+L7tyhsM485djkQ/ePZ8s8w8Uqflb75JQ=","junDWvKBIb/zqPoxOPmWz0tFlNgfiZxpwKYBKY5YZQA=","k2QZFq8tkAMoEUdmG9MgYOfx9sFFHvIIqvroIArbmSI=","k8nFaLU386vO8hvPpxkYiPtCFzcbzSTp3Hu/ErdKIr8=","kl2pC4rE52gn0NfznVNdKML+9S5eku8YnzUACABK4lw=","mpBCmktjvwPoGl9F6vwa5kmlvjWt9fBp8DaIITLYsj8=","mpi+mIoqZ9EM0e0NSC1mt/hndJozD58TJ7Z1w3cTD6E=","nY0qx00a91mJhN2e4Ly1j9aZ+cB1jB0Pk3e2n6wpcyU=","nc4bnQ7sUgGFvg/hJ8o5Ip8r9dUDqLFe42U1ZGg8cD4=","o0uEB98CI4J1TydI5Y1sagbLGZrp7VkeX6EWMITwT+Q=","oPY6q4ovXybZLyDqZmvHijytcBQQeXv+Hd/C0oWhYzU=","oiMxFRX72ewBUhGIBzHpjL29TsocBdiVGMMBetHKM48=","ox1vo8sWdwE2+YS6jiML+0XsY3sNMLts6Arsgbbx/8U=","pl6iXW3h5YQxetLyz4f+J9bhSHH4ui3xJ1l+ukuzn+Q=","ppncqXtC52/RLC8LWRJ363lOaTVGuuF9ZR8eizWxEZY=","qAHxwEIRjeiqT2JLpbNves4GF9toywYRVjYDLWeLn9c=","qTiurE0sSiy3++eCORnfn47d/eUuEQBbB1GMYvVX0Bc=","qgq3P9pR0fjUaZtvG7cegvFHKqkbyGoJAw2DdhA8q58=","qx+YVpjI5ZANruEr3C5G51nZ3peNexbw47IOKORS2vY=","rjb+gIk4vZTK5hvu56xe/jOWZIVGTvLaG70M17EWTog=","rtHAScahEScD7capKk1SeB5kVPg11sU5p8jg4IlycKo=","sD9FFohzIRAzPY9SMtMQ7jSZQ0a04G1KBBjzoBTJFtE=","t0VVnHGFyn0fpIEiPGwtM5cFH11EZ/wXsKQE3ckYVl8=","tM8HVujNAzHCvkfNPyevQkPlDN8TOADhLainJTK1QfE=","u2YqR2PhoH6VwKt66kpSQOpvLApYgU9GwAgp82uYXJ8=","uem4EkJujTHeW/D2E/QvmZy78HxvxPBN/G06ohPOsmg=","ujaxM65eIICu3ZK3IxTdJ7mtyWJypjFU6HRPsXJjOKE=","vGpV76mnRzZEExVIsE5zN/R65oWh59pqEW10CLj/uy0=","vNmoMwZ28o0pB3WICRCg4exe0brWMDGR3aLTEHqkKK4=","w+5iR/XTKCKKCC0/ReD9z25bxD/k1107Oamzo9KEBoA=","y2VLKhbYrt6ZwajKPa3GD/St0iOfmDVdTI23eHFfvRs=","ygBstCHAXHCrw32N5iwboFPxsyhn9LfqnHSaPyOoLfI=","ygGcjnvxqLKkz4nFsoDUd+I5zuUidRKfjypXH+dH3i8=","yscXwTD1X3WGYTIlZppyYOKx6Z5li9BgVJvQ31oJ2u8="];

var BASE_DIRECTIVES = [
  "default-src 'self'",
  "img-src 'self' data: blob:",
  "style-src 'self' 'unsafe-inline'",
  "font-src 'self' data:",
  "frame-ancestors 'none'",
  "base-uri 'self'",
  "form-action 'self'",
  "upgrade-insecure-requests"
];

var SCRIPT_PREFIX = "script-src 'self'";

// Include test domains so infra tests can validate connect-src values.
var CONNECT_SRC_BY_HOST = {
  "bjornmelin.io": "https://api.bjornmelin.io",
  "www.bjornmelin.io": "https://api.bjornmelin.io",
  "example.com": "https://api.example.com",
  "www.example.com": "https://api.example.com"
};

function normalizePath(uri) {
  if (!uri) return "/index.html";
  var raw = uri.split("?")[0].split("#")[0];
  var decoded;
  try {
    decoded = decodeURIComponent(raw);
  } catch (error) {
    decoded = raw;
  }
  if (decoded.charAt(decoded.length - 1) === "/") return decoded + "index.html";
  var lastSegment = decoded.split("/").pop() || "";
  if (lastSegment.indexOf(".") === -1) return decoded + "/index.html";
  return decoded;
}

function isHtmlRequest(request, response) {
  var uri = (request && request.uri) || "";
  if (!uri) return false;

  // Skip Next.js internal assets.
  if (uri.indexOf("/_next/") === 0) return false;

  // Prefer content-type when available (viewer-response).
  var contentType =
    response &&
    response.headers &&
    response.headers["content-type"] &&
    response.headers["content-type"].value;
  if (contentType && contentType.indexOf("text/html") === -1) return false;

  var pathOnly = uri.split("?")[0].split("#")[0];
  var last = pathOnly.split("/").pop() || "";
  if (last.indexOf(".") !== -1 && pathOnly.slice(-5) !== ".html") return false;
  return true;
}

function decodeHashList(encoded) {
  if (!encoded) return [];
  var parts = encoded.split(".");
  var out = [];
  for (var i = 0; i < parts.length; i++) {
    var idx = parseInt(parts[i], 36);
    if (isNaN(idx)) continue;
    var digest = HASH_B64[idx];
    if (!digest) continue;
    out.push(digest);
  }
  return out;
}

function buildCsp(host, hashes) {
  var normalizedHost = (host || "").toLowerCase().split(":")[0];
  var connectSrc = CONNECT_SRC_BY_HOST[normalizedHost];
  var scriptParts = [];
  for (var i = 0; i < hashes.length; i++) {
    scriptParts.push("'sha256-" + hashes[i] + "'");
  }
  var script = SCRIPT_PREFIX + (scriptParts.length ? " " + scriptParts.join(" ") : "");
  var connectDirective = connectSrc
    ? "connect-src 'self' " + connectSrc
    : "connect-src 'self'";
  return BASE_DIRECTIVES.concat([script, connectDirective]).join("; ");
}

// lgtm [js/unused-local-variable]
async function handler(event) {
  var request = event.request || {};
  var response = event.response || {};
  if (!isHtmlRequest(request, response)) return response;
  var uri = request.uri || "/index.html";
  var normalized = normalizePath(uri);
  var encoded;
  try {
    encoded = await kvsHandle.get(normalized);
  } catch (error) {
    encoded = null;
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/404.html");
    } catch (error) {
      encoded = null;
    }
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/index.html");
    } catch (error) {
      encoded = null;
    }
  }
  // Fail-soft: if KVS is unavailable/unpopulated, don't apply CSP yet.
  // The deploy pipeline syncs KVS immediately after the storage stack deploy.
  if (encoded == null) return response;
  var hashes = decodeHashList(encoded);
  var hostHeader =
    request.headers && request.headers.host && request.headers.host.value;
  var csp = buildCsp(hostHeader || "", hashes);
  response.headers = response.headers || {};
  response.headers["content-security-policy"] = { value: csp };
  return response;
}

