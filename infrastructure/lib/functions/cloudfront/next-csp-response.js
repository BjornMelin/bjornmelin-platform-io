/* biome-ignore format: Keep output compact (CloudFront Function 10 KB limit). */
/* biome-ignore-all assist/source/organizeImports: Generated file with compact output. */
/* biome-ignore-all lint/style/useTemplate: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/complexity/useOptionalChain: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noUnusedVariables: CloudFront handler is invoked by AWS. */
/* biome-ignore-all lint/style/useConst: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/suspicious/noGlobalIsNan: CloudFront Functions require ES5.1. */
/* biome-ignore-all lint/correctness/noInnerDeclarations: CloudFront Functions require ES5.1. */
/**
 * Generated file -- do not edit by hand.
 *
 * Generated by: `pnpm generate:csp-hashes`
 *
 * CloudFront Functions runtime constraints:
 * - JavaScript runtime 2.0
 * - Uses CloudFront KeyValueStore for per-path hash indices (keeps code size < 10 KB)
 */
import cf from "cloudfront";
var kvsHandle = cf.kvs();

var HASH_B64 = ["+1PElARwj1iUqw7qg9naL+OkuV1vcyYSuMSw1leJTG8=","+bEgLV2HgeUGx75Dn74Er4ojlfcKeNWN9b4wU8aBXLU=","/+GwKS8RMmXJVFHx50WyGF6HDz90wmJRJ5EMh3lkWmc=","152jtSE9F+BxstXwPFnZnO+f8oKiImbwTovxrFfddrg=","2xGw6cmfq9ck3egHESHW+jlG+Vebw3wEf+niYWkr3t0=","3O4YOTuA3jjrMtPnYgUzcPhkBlWIvvjRAvqJgFYTcQ8=","3aO1HwglNoNRAdrHsjvOr9Gcwil29GrLB2asVQqOmO4=","4ZfzSfwIj9DTVko8ScZMDriN19uw717rE8jJXkilIQs=","4p9RtPsHVy/heQAbfwfd7+0WCS5PhjWhBEEWHluz/+w=","6V20kPkQzwM0VVqjSGLTeQq5vxaJd0+YKPodJUkv0LM=","6etHJnoBx0v9aCrvl/LdrRAF2jzoRHfR6y4KStIDTBo=","6zTZ5HUCqP9ydOFhwxCpqQN5WQ0GsuT95UlKGnlrREk=","7DJ7/VylxtHKi7QaBukUz9yJHoDy9vJMe+Jvhf7PW84=","7mu4H06fwDCjmnxxr/xNHyuQC6pLTHr4M2E4jXw5WZs=","99x91BTBztiheamDaovTgGc/LcPOgXEYxWu+6PAwxlg=","9buxjszFdjpWUljTLbePEui7iKV8CkOF93OutNp387U=","A7DACxrIIwF5PaMc5bzYoDl13Y8YOu+xhX7OH40bg5k=","AFsupQJGsBY+zAfXP2knWZkhSybVlxn0i2htEdPJJgI=","BYNPgcQF16B6dGY4JfTH+Soqb7bbQ83xBSzrOlWYUlU=","BsJytk1oC6IXH23OVwJtsW+Yzsyucf0UVuWVroXkEoQ=","CT2ktZrpGypLXNnrjqdJ9O6rhDmih7278eKWQ0cu/bM=","Cq8btV/vi++vKKRdDI+B7Dfu9Ij3qvxQzDG5pVSA0pw=","DA7QjyGVk1f+cT7xElezDSKXBeDkyE/Y4k5hmAWdkdk=","E2aZjgKiPrsN5Iz6Hu+nyaDqJ+12A7g5OO/rXVMTJ1Q=","EJIacmeTuJcrkWeEp4PTrO+L0x85MZpKaVMhGlecqMA=","Er956Pf61oV4rVxE47P5q5I+bv0ZfdG6yHQXmOqxPoA=","Ey6994J7ex+kcB5LPc5bZiTZOR1967mPX/h67DJWxjA=","FHkq1yuhH8J+BADBg5S/YEHPxOrA8Uzx0xDv8oyshUo=","FxI+W5dgL3VVPTmjAV1jT4SChe39z1wxV9bLQDP2Rro=","Gu9TZULh5YaAHkB7+c2TuSlXgEKUv1wYt415DLJDiEk=","H8lQajQRcLaYdLwyY6KEgsOzFVlA73sPR/t3MEYHG7I=","IK1W5MpaFu7KXqi7xLhPngcAcgBqzHGqQeH/n/bOtZ0=","J5Khru3S8LIFTd8hC1SkVmWZLC44/WxeomvG2HLxThY=","J9fzR4xQ1+7MgJy0M2wXXSlDnp6VyJrrzMkc1NtxM6Y=","JMrVei7dLewkbqa/oEhFdzUKVKVNKeWEtV/WXYkQ37o=","JbuuplqZ9KZxN/teHCkmLOfbYJj/rzhD7OFEcfWxPG0=","KO9nN02LczRlJyfHwncnZXT2Vf9Bve2pxtiSWUC24UU=","LFLsnDBjJ7N55uXKcpfJDNFdf/+KUj66Pc3j/iiGpDk=","MvGkIuy4omP058O1rKq1BJ4cjtRWPeLD1LV/eBeU1ls=","MvrWQJW2THpuuI8UYun9USndVB4liEPCU0/mSm085/4=","OBTN3RiyCV4Bq7dFqZ5a2pAXjnCcCYeTJMO2I/LYKeo=","OVBifIYiG5+s05dWZNHmtxz6zBRb9d5vQZZAeYt4ogc=","PYrSCKBr0oxx4yW/tJehE4oav0mCIUOvh5xLsRzAR0Y=","PoUmiMVMVwMf3kHf+nIsGO3wck5fg8DrruuOLs+3+Sw=","QAlSewaQLi/NPCznjAZSyvQ72heD0VdxmNDDkZeCxgc=","QD9s9w7owX+gU8edvM8JFzV2FvWRe41TDvU3h94pIrg=","R/rFn5H6rksWYIZeSy8kn90WthpVvohJNTthnvFlFpk=","SMCmZQhUn5vZfmIUeNjxTog9iQ+0mcZgLOnV6qD06X8=","SsAiqdNaqOz0NdynhBjjZ6UgklReJmGNVo8jx5lThtA=","Ua3rtH/OkdkrpC64PfyXrfqS0mb1aIOEuIJys4fBg6k=","UfXOPgMgWXgVAc95Z63cpb0iBb05qzjpUP2QK1eM6qU=","VEY/OEE4t0sY0Oif0ABTgz2rAnu1M8udjOLsQf7Hf0M=","VWlVs7SAlpMMZDKbPM29cAr54iaUYHxtdVMsiCSi4lo=","VcoeU+J/RuZFcLHzshP9l+YOhg8Vi/+nsnpz/QktYQM=","WAFxALu3xDJOE13XbiFrBXi0XQnAOiYaJzRYajvjakY=","Wjqd1Z8focuJg6nrRg7QV2NMuiQrCVK372w1qVXVJ+c=","YpuuijLSzD5bh2KGxZqsIFvRjo64IGNf9QwNRdfyhn4=","Z/8yh2gQKwL/ML6uuo/O/+tLjFcPQBveGlMnQCFrYec=","Zh0fmOwSiqZ/Ia8wqnsuU0dQDc896NLr01y4LPPiF1E=","c+LqBZyrZGg707ci19vOA1VTh2QxCewllvOY26syDSw=","cL9jmtKpHqgFzGugh/AMHp00W5W3AE2BjiOhxEI/Pe8=","ctLQVDf0ehdhKY9CYu3XNzz/MuF57PjlLuvuMjz7gtI=","d3nW9C3MVxwZovx8p2NB4VQN7PEQz9hi6K3ATZJxnbY=","d4RBpQ9KKBwPmw+a1tovdpXlWYfWRVzU69j4TBYc+K0=","dItsZhaylcdHBbkVKBU6ND0noEycd7jp6NtVwQagWio=","eO5de2zEsL1+jchUhKZVMQrAJDANnPRR9bpC9kXENeY=","egYRgHXtBHY99JA82Vs+AKbYvaGECRQ46J34dbg1EtI=","eoVSr1RSYYcnZ0h6bcmq9ebcObjQ5gbo8XIrKACucJ4=","fm0qKWqyNb6TiMJxTaGhB7SF3+OJwCoJFxS9IHKCCOE=","h4+X9AV+OlK44McOkx7hjtZw72dU9WZAmwPsrHkmeYY=","hCF15Tr2/9i4D8W1N2gsIG68cEqhwGMZRAjJ5jHgX98=","hTPaoYI6JyMgRU/iU28TE9mFh5NexBD6oMI7nlAVtSc=","hc4DclDp6F5WARnzeo/huGEmTCd0UHqT5YMZOW0AztY=","iJVwjUWYhzeq6LbzCUBckBH6+Ey00rFYZbThdgW47uw=","j+FGYMM37ATPGLS3gcW3Abe/d3qXJ7lKB1RmYyA28zc=","k2QZFq8tkAMoEUdmG9MgYOfx9sFFHvIIqvroIArbmSI=","l7Jx2nHWfgvZxvpIE8PBJKOjY3glX7VGc8x1SH7OBbk=","lLu2ztmFXg4xd7QBgA89m80OGgXKcElg8Sj0eqopqfs=","lq6qS6wKLhA17miBhD/mZ+ZEN41z4YstdPvTE0rB/wo=","ltBh57lu87N6cINyQ7MDYPoXoYulNw4GJSWPGTQAO3Y=","n46vPwSWuMC0W703pBofImv82Z26xo4LXymv0E9caPk=","nWZnHy9c9WzOusTQTRaH2H2HLZW7+Fsmkw0ZX3I+ai4=","o9DhuImzjCFREE46vbXUrggvEOnnFtffKUfwd+cYm70=","oHAhhPa74+EQABIVD8izSvEcRVZU+WGAPjA50vaBcLY=","ppncqXtC52/RLC8LWRJ363lOaTVGuuF9ZR8eizWxEZY=","qzFF7EqXlcg7nbgTTxXIL9zqk405QQfBFawpEh2dxao=","rK1+SxvLstGbjEoBN+f0lq7JVAksLxLJQcQhjpkoAwk=","snpey9m99r5I8j3jsdnWSXNTb3tQSSoiBU/kjgNiKBA=","t0VVnHGFyn0fpIEiPGwtM5cFH11EZ/wXsKQE3ckYVl8=","tENbKDDxq5o4am7N3PaWSK75wt8gJ1Fz0iwoGt73upM=","tR/WhQjcCgsj4fDgE9l4oxkIP6dpi0O0ok0yCaiA2+M=","tV+KzqgijJh7tD834K8h5VA8mJdq4livRIBr46CWjeI=","tW+cDhPLj8SxDcRCyoOHRnKVAyNXIBMYNAd7uBIUtAs=","u2YqR2PhoH6VwKt66kpSQOpvLApYgU9GwAgp82uYXJ8=","udmcmh9tcLfeFyIPmEcvYj0quRfXwPcOFlzBD+2mscY=","uem4EkJujTHeW/D2E/QvmZy78HxvxPBN/G06ohPOsmg=","v1fF9Jxmfif2Ab0ExDvZ9rkS7mVay0ZMD+JeT/e1GhE=","vGpV76mnRzZEExVIsE5zN/R65oWh59pqEW10CLj/uy0=","vLmQS+knuZ/nIRhv7+bmbMMQb7AfhYua528GpzRjjho=","vyZhBa1TLZCsCkguB0zKF1wgqpDYMada12la6YdECB4=","xHDaqElzmJhcWhHCk97xPTExz4W1z/+0e7lW5s861sA=","xIgvKyy6i3plKe3Fob+oqDVd37aMI6gWx80PXT5GQgg=","xUc8gkN8Ln52DJiXborVfKA7yDXJuGCAQn42JS+rdVE=","yI2IdZ/f2cNQc1d/dJfgyA+bcntLdflfYBzds2e4wTI=","yNyiOkfGcHe84KZmpNpv8qb07cx9ks4qNi27hWtCyLs=","ywVcH5Wo6c8q0v/3+72uKViLwzy51UXBBApPQZkELBI=","zDQCAoblBxNvPEXH7LMKj4zZ2SyXLUunapB6wMl9eHs=","zXDcND5f4p2y150OHQ8FGI0kKsSh8nklh/fw9hnIvCM=","zv9a4pLGewl/N26PiT0RQdR/3ag1TnlqVDhWqJAZZPI="];

var BASE_DIRECTIVES = [
  "default-src 'self'",
  "img-src 'self' data: blob:",
  "style-src 'self' 'unsafe-inline'",
  "font-src 'self' data:",
  "frame-ancestors 'none'",
  "base-uri 'self'",
  "form-action 'self'",
  "upgrade-insecure-requests"
];

var SCRIPT_PREFIX = "script-src 'self'";

// Include test domains so infra tests can validate connect-src values.
var CONNECT_SRC_BY_HOST = {
  "bjornmelin.io": "https://api.bjornmelin.io",
  "www.bjornmelin.io": "https://api.bjornmelin.io",
  "example.com": "https://api.example.com",
  "www.example.com": "https://api.example.com"
};

function normalizePath(uri) {
  if (!uri) return "/index.html";
  var raw = uri.split("?")[0].split("#")[0];
  var decoded;
  try {
    decoded = decodeURIComponent(raw);
  } catch (error) {
    decoded = raw;
  }
  if (decoded.charAt(decoded.length - 1) === "/") return decoded + "index.html";
  var lastSegment = decoded.split("/").pop() || "";
  if (lastSegment.indexOf(".") === -1) return decoded + "/index.html";
  return decoded;
}

function isHtmlRequest(request, response) {
  var uri = (request && request.uri) || "";
  if (!uri) return false;

  // Skip Next.js internal assets.
  if (uri.indexOf("/_next/") === 0) return false;

  // Prefer content-type when available (viewer-response).
  var contentType =
    response &&
    response.headers &&
    response.headers["content-type"] &&
    response.headers["content-type"].value;
  if (contentType && contentType.indexOf("text/html") === -1) return false;

  var pathOnly = uri.split("?")[0].split("#")[0];
  var last = pathOnly.split("/").pop() || "";
  if (last.indexOf(".") !== -1 && pathOnly.slice(-5) !== ".html") return false;
  return true;
}

function decodeHashList(encoded) {
  if (!encoded) return [];
  var parts = encoded.split(".");
  var out = [];
  for (var i = 0; i < parts.length; i++) {
    var idx = parseInt(parts[i], 36);
    if (isNaN(idx)) continue;
    var digest = HASH_B64[idx];
    if (!digest) continue;
    out.push(digest);
  }
  return out;
}

function buildCsp(host, hashes) {
  var normalizedHost = (host || "").toLowerCase().split(":")[0];
  var connectSrc = CONNECT_SRC_BY_HOST[normalizedHost];
  var scriptParts = [];
  for (var i = 0; i < hashes.length; i++) {
    scriptParts.push("'sha256-" + hashes[i] + "'");
  }
  var script = SCRIPT_PREFIX + (scriptParts.length ? " " + scriptParts.join(" ") : "");
  var connectDirective = connectSrc
    ? "connect-src 'self' " + connectSrc
    : "connect-src 'self'";
  return BASE_DIRECTIVES.concat([script, connectDirective]).join("; ");
}

// lgtm [js/unused-local-variable]
async function handler(event) {
  var request = event.request || {};
  var response = event.response || {};
  if (!isHtmlRequest(request, response)) return response;
  var uri = request.uri || "/index.html";
  var normalized = normalizePath(uri);
  var encoded;
  try {
    encoded = await kvsHandle.get(normalized);
  } catch (error) {
    encoded = null;
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/404.html");
    } catch (error) {
      encoded = null;
    }
  }
  if (encoded == null) {
    try {
      encoded = await kvsHandle.get("/index.html");
    } catch (error) {
      encoded = null;
    }
  }
  // Fail-soft: if KVS is unavailable/unpopulated, don't apply CSP yet.
  // The deploy pipeline syncs KVS immediately after the storage stack deploy.
  if (encoded == null) return response;
  var hashes = decodeHashList(encoded);
  var hostHeader =
    request.headers && request.headers.host && request.headers.host.value;
  var csp = buildCsp(hostHeader || "", hashes);
  response.headers = response.headers || {};
  response.headers["content-security-policy"] = { value: csp };
  return response;
}

